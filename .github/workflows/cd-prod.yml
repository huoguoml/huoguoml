  
name:  CD Pipeline - Production

on:
  push:
    tags:
      - '*.*.*'

jobs:
  update_draft_release:
    runs-on: ubuntu-latest
    steps:
      # Drafts your next Release notes as Pull Requests are merged into "master"
      - uses: toolmantim/release-drafter@v5.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deployment:
    runs-on: ubuntu-latest
    needs:
      - update_draft_release
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.7
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Set up Node 14
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: Set env with tag name
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: Set version to tag
        run: |
          VERSION=${RELEASE_VERSION}
          PLACEHOLDER='__version__ = "0.0.1"'
          VERSION_FILE='huoguoml/__init__.py'
          grep "$PLACEHOLDER" "$VERSION_FILE"
          sed -i "s/$PLACEHOLDER/__version__ = \"${VERSION}\"/g" "$VERSION_FILE"
      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine
      - name: Build dashboard files
        working-directory: huoguoml/server/dashboard
        env:
          CI: false
        run: |
          yarn install
          yarn run build
          cp build/index.html build/404.html
          cp build/index.html build/405.html
      - name: Build and publish pip package
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          python setup.py sdist bdist_wheel
          twine upload dist/*